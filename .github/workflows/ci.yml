name: CI

# Platform Support Strategy:
# - Currently only Linux amd64 is fully implemented and tested
# - All other platforms have matrix entries ready with skip_tests: true
# - To enable a platform: change skip_tests to false and uncomment release builds
# - Release builds are prepared for all platforms but only execute for implemented ones

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run daily to catch any regressions from dependency updates
    - cron: '0 2 * * *'

jobs:
  # Test on Linux amd64 with multiple Rust versions
  test:
    name: Test (${{ matrix.os }}, ${{ matrix.arch }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux amd64 - stable
          - os: ubuntu-latest
            arch: amd64
            rust: stable
            target: x86_64-unknown-linux-gnu
          # Linux amd64 - beta
          - os: ubuntu-latest
            arch: amd64
            rust: beta
            target: x86_64-unknown-linux-gnu
          # Linux amd64 - MSRV
          - os: ubuntu-latest
            arch: amd64
            rust: '1.92'
            target: x86_64-unknown-linux-gnu

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.rust }}
        targets: ${{ matrix.target }}
        components: clippy, rustfmt

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Check formatting (Linux amd64 only)
      run: cargo fmt --all -- --check
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'amd64' && matrix.rust == 'stable'

    - name: Run clippy (Linux amd64 only)
      run: cargo clippy -- -D warnings
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'amd64' && matrix.rust == 'stable'

    - name: Build project
      run: cargo build --target ${{ matrix.target }} --verbose
      timeout-minutes: 30

    - name: Run tests
      run: cargo test --target ${{ matrix.target }} --verbose
      timeout-minutes: 20

  # Security audit
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cargo-audit
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-audit

    - name: Run security audit
      run: cargo audit
      continue-on-error: true

  # Check for unused dependencies
  udeps:
    name: Unused Dependencies
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: nightly

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2

    - name: Install cargo-udeps
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-udeps

    - name: Run unused dependencies check
      run: cargo +nightly udeps --all-targets

  # Check for outdated dependencies
  outdated:
    name: Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cargo-outdated
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-outdated

    - name: Check for outdated dependencies
      run: cargo outdated --root-deps-only --exit-code 1
      continue-on-error: true

  # Coverage reporting
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Install cargo-tarpaulin
      run: cargo install cargo-tarpaulin
      timeout-minutes: 15

    - name: Generate coverage report
      run: cargo tarpaulin --out Xml
      timeout-minutes: 30

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: cobertura.xml
        fail_ci_if_error: false