name: CI

# Platform Support Strategy:
# - Currently only Linux amd64 is fully implemented and tested
# - All other platforms have matrix entries ready with skip_tests: true
# - To enable a platform: change skip_tests to false and uncomment release builds
# - Release builds are prepared for all platforms but only execute for implemented ones

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run daily to catch any regressions from dependency updates
    - cron: '0 2 * * *'

jobs:
  # Test on multiple platforms and Rust versions
  test:
    name: Test (${{ matrix.os }}, ${{ matrix.arch }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux amd64 (implemented)
          - os: ubuntu-latest
            arch: amd64
            rust: stable
            target: x86_64-unknown-linux-gnu
            skip_tests: false
          - os: ubuntu-latest
            arch: amd64
            rust: beta
            target: x86_64-unknown-linux-gnu
            skip_tests: false
          - os: ubuntu-latest
            arch: amd64
            rust: '1.92'  # MSRV
            target: x86_64-unknown-linux-gnu
            skip_tests: false

          # Linux arm64 (ready for when implemented)
          - os: ubuntu-24.04-arm
            arch: arm64
            rust: stable
            target: aarch64-unknown-linux-gnu
            skip_tests: true

          # macOS amd64 (ready for when implemented)
          - os: macos-13
            arch: amd64
            rust: stable
            target: x86_64-apple-darwin
            skip_tests: true

          # macOS arm64 (ready for when implemented)
          - os: macos-latest
            arch: arm64
            rust: stable
            target: aarch64-apple-darwin
            skip_tests: true

          # Windows amd64 (ready for when implemented)
          - os: windows-latest
            arch: amd64
            rust: stable
            target: x86_64-pc-windows-msvc
            skip_tests: true

          # Windows arm64 (ready for when implemented)
          - os: windows-11-arm
            arch: arm64
            rust: stable
            target: aarch64-pc-windows-msvc
            skip_tests: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.rust }}
        targets: ${{ matrix.target }}
        components: clippy, rustfmt

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Check formatting (Linux amd64 only)
      run: cargo fmt --all -- --check
      if: ${{ matrix.os == 'ubuntu-latest' && matrix.arch == 'amd64' && matrix.rust == 'stable' && !matrix.skip_tests }}

    - name: Run clippy (Linux amd64 only)
      run: cargo clippy -- -D warnings
      if: ${{ matrix.os == 'ubuntu-latest' && matrix.arch == 'amd64' && matrix.rust == 'stable' && !matrix.skip_tests }}

    - name: Build project
      run: cargo build --target ${{ matrix.target }} --verbose
      if: ${{ !matrix.skip_tests }}

    - name: Run tests
      run: cargo test --target ${{ matrix.target }} --verbose
      if: ${{ !matrix.skip_tests }}

    - name: Run doc tests
      run: cargo test --target ${{ matrix.target }} --doc
      if: ${{ !matrix.skip_tests }}

  # Security audit
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Cache cargo-audit
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-audit
        key: ${{ runner.os }}-cargo-audit-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-audit-

    - name: Install cargo-audit
      run: |
        if ! command -v cargo-audit &> /dev/null; then
          cargo install cargo-audit --locked
        fi

    - name: Run security audit
      run: cargo audit

  # Check for unused dependencies
  udeps:
    name: Unused Dependencies
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: nightly

    - name: Cache cargo-udeps
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-udeps
        key: ${{ runner.os }}-cargo-udeps-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-udeps-

    - name: Install cargo-udeps
      run: |
        if ! command -v cargo-udeps &> /dev/null; then
          cargo install cargo-udeps --locked
        fi

    - name: Run unused dependencies check
      run: cargo +nightly udeps --all-targets

  # Check for outdated dependencies
  outdated:
    name: Outdated Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Cache cargo-outdated
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-outdated
        key: ${{ runner.os }}-cargo-outdated-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-outdated-

    - name: Install cargo-outdated
      run: |
        if ! command -v cargo-outdated &> /dev/null; then
          cargo install cargo-outdated --locked
        fi

    - name: Check for outdated dependencies
      run: cargo outdated --exit-code 1

  # Coverage reporting
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Install cargo-tarpaulin
      run: cargo install cargo-tarpaulin

    - name: Generate coverage report
      run: cargo tarpaulin --out Xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: cobertura.xml
        fail_ci_if_error: false

  # Release automation
  release:
    name: Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: x86_64-unknown-linux-gnu,x86_64-pc-windows-gnu,x86_64-apple-darwin,aarch64-apple-darwin,aarch64-unknown-linux-gnu,aarch64-pc-windows-msvc

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64

    - name: Install cargo-release
      run: cargo install cargo-release

    - name: Check if version should be released
      id: check
      run: |
        # Check if there are commits since last tag
        if git describe --tags --abbrev=0 > /dev/null 2>&1; then
          LAST_TAG=$(git describe --tags --abbrev=0)
          if git rev-list $LAST_TAG..HEAD --count | grep -q '^0$'; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Create release
      if: steps.check.outputs.skip == 'false'
      run: |
        # Build release binaries for supported platforms
        # Currently only Linux amd64 is implemented

        # Linux amd64 (implemented)
        echo "Building for Linux amd64..."
        cargo build --release --target x86_64-unknown-linux-gnu

        # Linux arm64 (when implemented - requires aarch64 runner)
        # echo "Building for Linux arm64..."
        # cargo build --release --target aarch64-unknown-linux-gnu

        # Windows amd64 (when implemented)
        # echo "Building for Windows amd64..."
        # cargo build --release --target x86_64-pc-windows-gnu

        # Windows arm64 (when implemented - requires Windows arm64 runner)
        # echo "Building for Windows arm64..."
        # cargo build --release --target aarch64-pc-windows-msvc

        # macOS amd64 (when implemented - requires macOS runner)
        # echo "Building for macOS amd64..."
        # cargo build --release --target x86_64-apple-darwin

        # macOS arm64 (when implemented - requires macOS runner)
        # echo "Building for macOS arm64..."
        # cargo build --release --target aarch64-apple-darwin

        # Create release archives
        mkdir -p release-artifacts

        # Copy built binaries
        cp target/x86_64-unknown-linux-gnu/release/driftless release-artifacts/driftless-linux-amd64

        # Uncomment when platforms are implemented:
        # cp target/aarch64-unknown-linux-gnu/release/driftless release-artifacts/driftless-linux-arm64
        # cp target/x86_64-pc-windows-gnu/release/driftless.exe release-artifacts/driftless-windows-amd64.exe
        # cp target/aarch64-pc-windows-msvc/release/driftless.exe release-artifacts/driftless-windows-arm64.exe
        # cp target/x86_64-apple-darwin/release/driftless release-artifacts/driftless-macos-amd64
        # cp target/aarch64-apple-darwin/release/driftless release-artifacts/driftless-macos-arm64

        # Make binaries executable
        chmod +x release-artifacts/driftless-linux-amd64
        # chmod +x release-artifacts/driftless-linux-arm64
        # chmod +x release-artifacts/driftless-macos-amd64
        # chmod +x release-artifacts/driftless-macos-arm64

    - name: Upload release artifacts
      if: steps.check.outputs.skip == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: driftless-release-${{ github.sha }}
        path: release-artifacts/
        retention-days: 30