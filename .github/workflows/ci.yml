name: CI

# Platform Support Strategy:
# - Currently only Linux amd64 is fully implemented and tested
# - All other platforms have matrix entries ready with skip_tests: true
# - To enable a platform: change skip_tests to false and uncomment release builds
# - Release builds are prepared for all platforms but only execute for implemented ones

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run daily to catch any regressions from dependency updates
    - cron: '0 2 * * *'

jobs:
  # Test on multiple platforms and Rust versions
  test:
    name: Test (${{ matrix.os }}, ${{ matrix.arch }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux amd64 (implemented)
          - os: ubuntu-latest
            arch: amd64
            rust: stable
            target: x86_64-unknown-linux-gnu
            skip_tests: false
          - os: ubuntu-latest
            arch: amd64
            rust: beta
            target: x86_64-unknown-linux-gnu
            skip_tests: false
          - os: ubuntu-latest
            arch: amd64
            rust: '1.92'  # MSRV
            target: x86_64-unknown-linux-gnu
            skip_tests: false

          # Linux arm64 (ready for when implemented)
          - os: ubuntu-24.04-arm
            arch: arm64
            rust: stable
            target: aarch64-unknown-linux-gnu
            skip_tests: true

          # macOS amd64 (ready for when implemented)
          - os: macos-13
            arch: amd64
            rust: stable
            target: x86_64-apple-darwin
            skip_tests: true

          # macOS arm64 (ready for when implemented)
          - os: macos-latest
            arch: arm64
            rust: stable
            target: aarch64-apple-darwin
            skip_tests: true

          # Windows amd64 (ready for when implemented)
          - os: windows-latest
            arch: amd64
            rust: stable
            target: x86_64-pc-windows-msvc
            skip_tests: true

          # Windows arm64 (ready for when implemented)
          - os: windows-11-arm
            arch: arm64
            rust: stable
            target: aarch64-pc-windows-msvc
            skip_tests: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.rust }}
        targets: ${{ matrix.target }}
        components: clippy, rustfmt

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Check formatting (Linux amd64 only)
      run: cargo fmt --all -- --check
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'amd64' && matrix.rust == 'stable' && matrix.skip_tests == false

    - name: Run clippy (Linux amd64 only)
      run: cargo clippy -- -D warnings
      if: matrix.os == 'ubuntu-latest' && matrix.arch == 'amd64' && matrix.rust == 'stable' && matrix.skip_tests == false

    - name: Build project
      run: cargo build --target ${{ matrix.target }} --verbose
      if: matrix.skip_tests == false
      timeout-minutes: 30

    - name: Run tests
      run: cargo test --target ${{ matrix.target }} --verbose
      if: matrix.skip_tests == false
      timeout-minutes: 20

  # Security audit
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Cache cargo-audit
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-audit
        key: ${{ runner.os }}-cargo-audit-v1
        restore-keys: |
          ${{ runner.os }}-cargo-audit-

    - name: Install cargo-audit
      run: |
        if ! command -v cargo-audit &> /dev/null; then
          cargo install cargo-audit --locked
        fi
      timeout-minutes: 15

    - name: Run security audit
      run: cargo audit
      continue-on-error: true

  # Check for unused dependencies
  udeps:
    name: Unused Dependencies
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: nightly

    - name: Cache cargo-udeps
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-udeps
        key: ${{ runner.os }}-cargo-udeps-v1
        restore-keys: |
          ${{ runner.os }}-cargo-udeps-

    - name: Install cargo-udeps
      run: |
        if ! command -v cargo-udeps &> /dev/null; then
          cargo install cargo-udeps --locked
        fi
      timeout-minutes: 15

    - name: Run unused dependencies check
      run: cargo +nightly udeps --all-targets

  # Check for outdated dependencies
  outdated:
    name: Outdated Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Cache cargo-outdated
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-outdated
        key: ${{ runner.os }}-cargo-outdated-v1
        restore-keys: |
          ${{ runner.os }}-cargo-outdated-

    - name: Install cargo-outdated
      run: |
        if ! command -v cargo-outdated &> /dev/null; then
          cargo install cargo-outdated --locked
        fi
      timeout-minutes: 15

    - name: Check for outdated dependencies
      run: cargo outdated --exit-code 1
      continue-on-error: true

  # Coverage reporting
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Install cargo-tarpaulin
      run: cargo install cargo-tarpaulin
      timeout-minutes: 15

    - name: Generate coverage report
      run: cargo tarpaulin --out Xml
      timeout-minutes: 30

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: cobertura.xml
        fail_ci_if_error: false