name: Generate Documentation

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/apply/**'
      - 'docs/**'
      - 'build.rs'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/apply/**'
      - 'docs/**'
      - 'build.rs'

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        components: rust-docs

    - name: Build project
      run: cargo build --release

    - name: Generate documentation
      run: |
        # Generate task documentation (using correct paths)
        ./target/release/driftless docs --format markdown --output docs/tasks-reference.md

        # Generate Rust API documentation
        cargo doc --no-deps --document-private-items

    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: |
          docs/
          target/doc/

    - name: Commit generated documentation (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Check if docs have changed
        if git diff --quiet docs/tasks-reference.md docs/schema/apply-config.schema.json docs/examples/; then
          echo "No documentation changes detected"
        else
          git add docs/tasks-reference.md docs/schema/apply-config.schema.json docs/examples/
          git commit -m "docs: update generated documentation [skip ci]" || echo "No changes to commit"
          git push
        fi

    - name: Deploy to GitHub Pages (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./target/doc
        destination_dir: api

    - name: Comment on PR with documentation links
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { issue: { number: issue_number }, repo: { owner, repo } } = context;
          const runId = context.runId;

          github.rest.issues.createComment({
            issue_number,
            owner,
            repo,
            body: `ðŸ“š **Documentation Generated**

            View the generated documentation:
            - [Task Reference](https://github.com/${owner}/${repo}/actions/runs/${runId}#artifacts)
            - [API Documentation](https://github.com/${owner}/${repo}/actions/runs/${runId}#artifacts)

            The documentation includes:
            - Complete task reference with examples
            - JSON schema for validation
            - Rust API documentation`
          });