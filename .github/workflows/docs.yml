name: Generate Documentation

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'docs/**'
      - 'Cargo.toml'
      - 'scripts/generate-docs.sh'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: rust-docs

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Build project
      run: cargo build

    - name: Generate documentation
      run: |
        # Make script executable and run it
        chmod +x ./scripts/generate-docs.sh
        ./scripts/generate-docs.sh

    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-${{ github.sha }}
        path: |
          docs/
          target/doc/
        retention-days: 30

    - name: Commit generated documentation (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "github-actions[bot]"

        # Check if docs have changed
        if git diff --quiet docs/tasks-reference.md docs/facts-reference.md docs/logs-reference.md docs/template-reference.md 2>/dev/null; then
          echo "No documentation changes detected"
        else
          git add docs/tasks-reference.md docs/facts-reference.md docs/logs-reference.md docs/template-reference.md
          git commit -m "docs: update generated documentation [skip ci]" --allow-empty || echo "No changes to commit"
          git push
        fi

    - name: Prepare GitHub Pages deployment (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        # Create a temporary directory for GitHub Pages content
        mkdir -p gh-pages-deploy
        
        # Copy Rust API docs to api subdirectory
        cp -r target/doc gh-pages-deploy/api
        
        # Copy markdown docs to docs subdirectory if they exist
        mkdir -p gh-pages-deploy/docs
        if [ -d docs ] && find docs -maxdepth 1 -name "*.md" -type f | grep -q .; then
          cp docs/*.md gh-pages-deploy/docs/
          echo "Copied markdown documentation files"
        else
          echo "Warning: No markdown documentation files found in docs/"
        fi
        
        # Determine the crate name from Cargo.toml
        CRATE_NAME=$(grep '^name = ' Cargo.toml | head -1 | sed 's/name = [\"]*\([^\"]*\)[\"]*$/\1/')
        echo "Detected crate name: $CRATE_NAME"
        
        # Create index.html from template
        cp .github/workflows/index.html.template gh-pages-deploy/index.html
        
        # Replace the crate name placeholder in index.html
        sed -i "s/CRATE_NAME_PLACEHOLDER/$CRATE_NAME/g" gh-pages-deploy/index.html
        
        # Create .nojekyll to disable Jekyll processing
        touch gh-pages-deploy/.nojekyll
    
    - name: Deploy to GitHub Pages (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./gh-pages-deploy
        force_orphan: true

    - name: Comment on PR with documentation links
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { issue: { number: issue_number }, repo: { owner, repo } } = context;
          const runId = context.runId;
          const sha = context.sha;

          github.rest.issues.createComment({
            issue_number,
            owner,
            repo,
            body: `ðŸ“š **Documentation Generated**

            View the generated documentation:
            - [ðŸ“„ Task Reference & Examples](https://github.com/${owner}/${repo}/actions/runs/${runId}#artifacts)
            - [ðŸ”§ API Documentation](https://github.com/${owner}/${repo}/actions/runs/${runId}#artifacts)

            **What's included:**
            - Complete task reference with examples
            - Facts, logs, and template documentation
            - Comprehensive Rust API documentation
            - Usage examples and best practices

            _Documentation is automatically updated on main branch pushes._`
          });