name: Generate Documentation

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'docs/**'
      - 'Cargo.toml'
      - 'scripts/generate-docs.sh'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'docs/**'
      - 'Cargo.toml'
      - 'scripts/generate-docs.sh'
  workflow_dispatch:

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: rust-docs

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Build project
      run: cargo build

    - name: Generate documentation
      run: |
        # Make script executable and run it
        chmod +x ./scripts/generate-docs.sh
        ./scripts/generate-docs.sh

    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-${{ github.sha }}
        path: |
          docs/
          target/doc/
        retention-days: 30

    - name: Commit generated documentation (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "github-actions[bot]"

        # Check if docs have changed
        if git diff --quiet docs/tasks-reference.md docs/facts-reference.md docs/logs-reference.md docs/template-reference.md 2>/dev/null; then
          echo "No documentation changes detected"
        else
          git add docs/tasks-reference.md docs/facts-reference.md docs/logs-reference.md docs/template-reference.md
          git commit -m "docs: update generated documentation [skip ci]" --allow-empty || echo "No changes to commit"
          git push
        fi

    - name: Prepare GitHub Pages deployment (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        # Create a temporary directory for GitHub Pages content
        mkdir -p gh-pages-deploy
        
        # Copy Rust API docs to api subdirectory
        cp -r target/doc gh-pages-deploy/api
        
        # Copy markdown docs to docs subdirectory
        mkdir -p gh-pages-deploy/docs
        cp docs/*.md gh-pages-deploy/docs/ || true
        
        # Create a simple index.html that redirects to API docs
        cat > gh-pages-deploy/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Driftless Documentation</title>
            <meta http-equiv="refresh" content="0; url=api/driftless/">
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background: #f5f5f5;
                }
                .container {
                    text-align: center;
                    padding: 2rem;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                h1 { color: #333; margin-bottom: 1rem; }
                p { color: #666; margin-bottom: 1.5rem; }
                a {
                    display: inline-block;
                    padding: 0.75rem 1.5rem;
                    margin: 0.5rem;
                    background: #0366d6;
                    color: white;
                    text-decoration: none;
                    border-radius: 6px;
                    transition: background 0.2s;
                }
                a:hover { background: #0256c7; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>Driftless Documentation</h1>
                <p>Redirecting to API documentation...</p>
                <p>If you are not redirected automatically, use the links below:</p>
                <div>
                    <a href="api/driftless/">API Documentation</a>
                </div>
            </div>
        </body>
        </html>
        EOF
        
        # Create .nojekyll to disable Jekyll processing
        touch gh-pages-deploy/.nojekyll
    
    - name: Deploy to GitHub Pages (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./gh-pages-deploy
        force_orphan: true

    - name: Comment on PR with documentation links
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { issue: { number: issue_number }, repo: { owner, repo } } = context;
          const runId = context.runId;
          const sha = context.sha;

          github.rest.issues.createComment({
            issue_number,
            owner,
            repo,
            body: `ðŸ“š **Documentation Generated**

            View the generated documentation:
            - [ðŸ“„ Task Reference & Examples](https://github.com/${owner}/${repo}/actions/runs/${runId}#artifacts)
            - [ðŸ”§ API Documentation](https://github.com/${owner}/${repo}/actions/runs/${runId}#artifacts)

            **What's included:**
            - Complete task reference with examples
            - Facts, logs, and template documentation
            - Comprehensive Rust API documentation
            - Usage examples and best practices

            _Documentation is automatically updated on main branch pushes._`
          });